name: Build

on:
  push:
    branches: [ '**' ]
  pull_request:
    branches: [ '**' ]
  workflow_dispatch:

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            -   uses: actions/checkout@v3
                with:
                    fetch-depth: 0 # Need to fetch all for proper history
            -   name: Collect build info
                id: info
                run: |
                    # Get short SHA
                    SHA_SHORT=$(git rev-parse --short HEAD)
                    echo "sha_short=$SHA_SHORT" >> $GITHUB_OUTPUT
                    
                    # Extract version from csproj
                    VERSION=$(grep -oP '(?<=<Version>)[^<]+' RenderiteHook/RenderiteHook.csproj)
                    echo "version=$VERSION" >> $GITHUB_OUTPUT
                    echo "Version found: $VERSION"
            -   uses: actions/setup-dotnet@v4
                with:
                    dotnet-version: "9.0.x"
            -   name: Install Cake Tool
                run: dotnet tool restore
            -   name: Build with Cake
                run: dotnet cake --target=Build --verbosity=normal
            -   name: Upload artifacts
                uses: actions/upload-artifact@v4
                with:
                    name: RenderiteHook-${{ steps.info.outputs.version }}-${{ steps.info.outputs.sha_short }}
                    path: |
                        ./RenderiteHook/bin/Release/*.dll
                        ./build/*.zip